define("lesson/js/task",["lesson/js/common","lesson/js/jquery.upload"],function(n){function o(n){this.init(n)}return o.prototype={taskPannel:"#task-pannel",init:function(n,o){var e=this,t=App.MEDIAINFO.info,i=App.MEDIAINFO.reply;if(this.hrefArr=[],this.renderCont(),t.length>0){for(var a=0;a<t.length;a++)this.hrefArr.push("//climg.mukewang.com/down/"+t[a].url+"."+t[a].type);this.renderTaskInit(!0)}else this.renderTaskInit(!1);2==i.remaincount&&(i.upload=!0),this.commentData=i,this.renderUpload(i),o||e.bindEvents(),n&&n()},properties:function(){this.$TaskParent=$("#task-pannel")},renderTaskInit:function(n){var o=$("#task-item-tpl").html(),e=$(this.taskPannel).find(".content"),t={};t.matter=n,t.cid=OP_CONFIG.curCourse.id,App.NEXTMEDIAINFO&&(t.mid=App.NEXTMEDIAINFO.id),e.html(juicer(o,t))},bindEvents:function(){var o=this;$(this.taskPannel).on("click",".js-download",function(){o.downloadFile()}).on("click",".js-retransmitted",function(){var n={upload:!0};if(2==o.commentData.remaincount)return o.renderUpload(n),void o.commentShow();var e={callback:function(){o.renderUpload(n),o.commentShow()}};$.confirm("本节作业共可提交两次，你还剩1次提交机会，提交后所得分数将作为本节的最终得分，确认提交吗？",e),$(".moco-modal-layer").addClass("task-modal")}).on("click",".js-comment-more",function(){var e=$(o.taskPannel).find(".comment-p").height();$(o.taskPannel).find(".divp").css("max-height",e).find(".m").remove(),$(this).parents(".comment-more").remove(),n.emit("lesson.resize")}),$("#cont-pannel").on("click",".js-pingfen-btn",function(){var o=$(".js-pingfen-box");o.is(":hidden")?o.show():o.hide(),n.emit("lesson.resize")})},downloadFile:function(){var n=this.hrefArr,o=0,e=function(){setTimeout(function(){window.location.href=n[o],o++,o<n.length&&e()},500)};e(o)},renderUpload:function(n){n.comment?(this.commentShow("comment"),n.name=n.userfilename,n.url=n.userfileurl):!n.canupload&&n.remaincount<2&&(n.uploadsuccess=!0,n.name=n.userfilename,n.url=n.userfileurl,this.commentShow("uploadsuccess"));var o=$("#task-upload-tpl").html(),e=$("#task-uploader");e.html(juicer(o,n)),n.upload&&this.uploadEvent()},commentShow:function(n){var o=$(".comment"),e=this.commentData,t=$(".comment-t");if(o.find(".wait").hide(),o.find(".wait2").hide(),o.find(".next-media").hide(),t.hide(),"onSelect"==n)return 2==e.remaincount?void o.find(".wait").show():void o.find(".wait2").show();if("onUploadError"!=n)if("uploadsuccess"==n)1==e.remaincount?o.find(".wait").show():o.find(".wait2").show(),o.find(".next-media").show();else if("comment"==n){var i=$("#task-comment-tpl").html();t.html(juicer(i,e)).show(),o.find(".next-media").show(),o.find(".comment-p").height()>96&&(o.find(".m").show(),o.find(".comment-more").show())}},renderCont:function(){var n={};n.name=App.MEDIAINFO.chapter_media+" 作业",n.desc=App.MEDIAINFO.job_desc,n.answer=App.MEDIAINFO.job_answer,n.task=App.MEDIAINFO.job_task,n.grading_front=App.MEDIAINFO.grading_front,n.videourl=App.MEDIAINFO.video_url;var o=$("#taskCont-tpl").html(),e=$("#cont-pannel .content");e.html(juicer(o,n))},uploadEvent:function(){var n=this;$("#js-upload-file").Huploadify({auto:!0,fileTypeExts:"*.zip; *.rar; *.7z",multi:!0,buttonText:"上传我的作业",formData:{key:Math.floor(1e7*Math.random()),mid:$.hash("mid"),cid:OP_CONFIG.curCourse.id,chpid:App.MEDIAINFO.chapter_id},fileSizeLimit:102400,showUploadedPercent:!0,showUploadedSize:!0,removeTimeout:9999999,uploader:"/lesson/ajaxuserupload",onUploadStart:function(){},onInit:function(){},onUploadSuccess:function(o,e){1==e.result?n.onUploadSuccess(e):n.onUploadError()},onSelect:function(){n.commentShow("onSelect")},onUploadError:function(){n.onUploadError()},onUploadComplete:function(){},onDelete:function(){n.commentShow()}})},onUploadError:function(){var n={upload:!1,uploaderror:!0};this.commentShow("onUploadError"),this.renderUpload(n)},onUploadSuccess:function(o){var e=o.data;e.upload=!1,e.uploadsuccess=!0,2==this.commentData.remaincount&&n.emit("lesson.finish"),this.renderUpload(e),this.commentData.remaincount--,this.commentShow("uploadsuccess")}},{init:function(n){return new o(n)}}});