define("lesson/js/jquery.upload",["require","exports","module"],function(){!function(e){e.fn.Huploadify=function(t){var n={fileTypeExts:"",uploader:"",auto:!1,method:"post",multi:!0,formData:null,fileObjName:"file",fileSizeLimit:2048,showUploadedPercent:!0,showUploadedSize:!1,buttonText:"选择文件",removeTimeout:1e3,onUploadStart:null,onUploadSuccess:null,onUploadComplete:null,onUploadError:null,onInit:null,onCancel:null},l=e.extend(n,t),a=!1,o=function(e,t){return e=e>1048576&&!t?(Math.round(100*e/1048576)/100).toString()+"MB":(Math.round(100*e/1024)/100).toString()+"KB"},i=function(e){for(var t=[],n=e.split(";"),l=0,a=n.length;a>l;l++)t.push(n[l].split(".").pop());return t};this.each(function(){var t=e(this),n=e(".uploadify").length+1,s='<input id="select_btn_'+n+'" class="selectbtn" style="display:none;" type="file" name="fileselect[]"';s+=l.multi?" multiple":"",s+=' accept="',s+=i(l.fileTypeExts).join(","),s+='"/>',s+='<a id="file_upload_'+n+'-button" href="javascript:;" class="uploadify-button">',s+=l.buttonText,s+="</a>",t.append(s);var r={init:function(){this.fileInput.length>0&&this.fileInput.change(function(e){r.funGetFiles(e)}),t.find(".uploadify-button").on("click",function(){t.find(".selectbtn").trigger("click")}),l.onInit&&l.onInit()},funGetFiles:function(e){var t=e.target.files;t=this.filter(t);for(var n=0;n<t.length;n++)this.fileFilter.push(t[n]);return this.funDealFiles(t),this},funDealFiles:function(e){for(var t=0,n=0,l=e.length;l>n;n++)e[n].index=++t,e[n].id=e[n].index;return this.onSelect(e),this},fileInput:t.find(".selectbtn"),uploadFileList:e(".uploading"),url:l.uploader,fileFilter:[],filter:function(t){var n=[],a=i(l.fileTypeExts);if(a.length>0)for(var s=0,r=t.length;r>s;s++){var p=t[s];parseInt(o(p.size,!0))>l.fileSizeLimit?e.alert("文件"+p.name+"大小超出限制！"):e.inArray(p.name.split(".").pop(),a)>=0?n.push(p):e.alert("文件"+p.name+"类型不允许！")}return n},onSelect:function(t){var n=t[0],i='<div class="uploading">';i+='<div class="progress">',i+='<span class="up_percent">0</span>%',i+="</div>",i+='<div class="speed">',i+='<span class="mr10">',i+='<span class="uploadedsize">0KB</span>',i+="/",i+='<span class="totalsize">'+o(n.size)+"</span>",i+="</span>",i+="<span>["+n.name+"]</span>",i+="</div>",i+='<a href="javascript:;" class="cancelupload js-cancelupload">取消上传</a>',e("#task-uploader").html(i),l.onSelect&&l.onSelect(),this.funUploadFile(n),e("#task-uploader").on("click",".js-cancelupload",function(){a?a.abort():window.location.reload()})},onProgress:function(t,n,l){var a=e(".uploading"),i=(n/l*100).toFixed(0);a.find(".uploadedsize").text(o(n)),a.find(".totalsize").text(o(l)),a.find(".up_percent").text(i)},funUploadFile:function(e){var t=!1;try{t=new XMLHttpRequest}catch(n){t=ActiveXobject("Msxml12.XMLHTTP")}if(a=t,t.upload){t.upload.addEventListener("progress",function(t){r.onProgress(e,t.loaded,t.total)},!1),t.onreadystatechange=function(){if(4==t.readyState){var n;n=""==t.responseText?!1:JSON.parse(t.responseText),200==t.status?l.onUploadSuccess&&l.onUploadSuccess(e,n):l.onUploadError&&l.onUploadError(e,n),l.onUploadComplete&&l.onUploadComplete(e,n),r.fileInput.val("")}},l.onUploadStart&&l.onUploadStart(),t.open(l.method,this.url,!0),t.setRequestHeader("X-Requested-With","XMLHttpRequest");var o=new FormData;if(o.append(l.fileObjName,e),l.formData)for(key in l.formData)o.append(key,l.formData[key]);t.send(o)}}};r.init()})}}(jQuery)});